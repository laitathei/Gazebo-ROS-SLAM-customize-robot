<?xml version="1.0" ?>
<robot name = "my_robot" xmlns:xacro="http://www.ros.org/wiki/xacro">

    <xacro:include filename="$(find realsense_ros_gazebo)/xacro/inertia_calc.xacro"/>
    <xacro:include filename="$(find slam_car)/urdf/camera.xacro"/>

	<gazebo reference="right_front_wheel">
		<material>Gazebo/Red</material>
	</gazebo>
	<gazebo reference="left_front_wheel">
		<material>Gazebo/Red</material>
	</gazebo>
	<gazebo reference="right_back_wheel">
		<material>Gazebo/Red</material>
	</gazebo>
	<gazebo reference="left_back_wheel">
		<material>Gazebo/Red</material>
	</gazebo>
	<gazebo reference="left_wheel_middle">
		<material>Gazebo/Blue</material>
	</gazebo>
	<gazebo reference="right_wheel_middle">
		<material>Gazebo/Blue</material>
	</gazebo>
    <xacro:property name="radius" value="0.05"/>
    <xacro:property name="length" value="0.1"/>
    <xacro:property name="d435_cam_depth_to_left_ir_offset" value="0.0"/>
    <xacro:property name="d435_cam_depth_to_right_ir_offset" value="-0.050"/>
    <xacro:property name="d435_cam_depth_to_color_offset" value="0.015"/>
    <xacro:property name="d435_cam_width" value="0.090"/>
    <xacro:property name="d435_cam_height" value="0.025"/>
    <xacro:property name="d435_cam_depth" value="0.02505"/>
    <xacro:property name="d435_cam_mass" value="0.564"/>
    <xacro:property name="d435_cam_mount_from_center_offset" value="0.0149"/>
    <xacro:property name="d435_cam_depth_px" value="${d435_cam_mount_from_center_offset}"/>
    <xacro:property name="d435_cam_depth_py" value="0.0175"/>
    <xacro:property name="d435_cam_depth_pz" value="${d435_cam_height/2}"/>
    <xacro:property name="sensor_name" value="realsense_D435i" />
    <xacro:property name="deg_to_rad" value="0.01745329251994329577" />
    <xacro:property name="rate" value="50" />
    <xacro:property name="pi" value="3.14159265359" />

	<!-- 1st link -->
	<link name="link_chassis">
		<inertial>
			<mass value="15"/>
			<origin xyz="0 0 0" rpy="0 0 0"/>
			<inertia ixx="1" ixy="0" ixz="0" iyy="1" iyz="0" izz="1"/>
		</inertial>

		<collision name="collision_chassis">
			<geometry>
				<box size="0.4 0.25 0.1"/>
			</geometry>
		</collision>

		<visual>
			<origin rpy="0 0 0" xyz="0 0 0"/>
			<geometry>
				<box size="0.4 0.25 0.1"/>
			</geometry>
		</visual>
	</link>

	<!-- 2rd link -->
	<link name="right_front_wheel">
		<collision name="right_front_wheel">
			<origin xyz="0 0 0" rpy="0 ${pi/2} 0"/>
				<geometry>
					<cylinder length="${length}" radius="${radius}"/>
				</geometry>
		</collision>

		<visual>
			<origin xyz="0 0 0" rpy="0 ${pi/2} 0"/>
				<geometry>
					<cylinder length="${length}" radius="${radius}"/>
				</geometry>
			<material name="Red">
				<color rgba="0.8 0.0 0.0 1.0"/>
			</material>
		</visual>

		<inertial>
			<mass value="1" />
			<origin xyz="0 0 0" rpy="0 ${pi/2} 0"/>
			<inertia ixx="1" ixy="0" ixz="0" iyy="1" iyz="0" izz="1" />
		</inertial>
	</link>

	<!-- 3th link -->
	<link name="right_back_wheel">
		<collision name="right_front_wheel">
			<origin xyz="0 0 0" rpy="0 ${pi/2} 0"/>
				<geometry>
					<cylinder length="${length}" radius="${radius}"/>
				</geometry>
		</collision>

		<visual>
			<origin xyz="0 0 0" rpy="0 ${pi/2} 0"/>
				<geometry>
					<cylinder length="${length}" radius="${radius}"/>
				</geometry>
			<material name="Red">
				<color rgba="0.8 0.0 0.0 1.0"/>
			</material>
		</visual>

		<inertial>
			<mass value="1" />
			<origin xyz="0 0 0" rpy="0 ${pi/2} 0"/>
			<inertia ixx="1" ixy="0" ixz="0" iyy="1" iyz="0" izz="1" />
		</inertial>
	</link>

	<!-- 4th link -->
	<link name="left_front_wheel">
		<collision name="left_front_wheel">
			<origin xyz="0 0 0" rpy="0 ${pi/2} 0"/>
				<geometry>
					<cylinder length="${length}" radius="${radius}"/>
				</geometry>
		</collision>

		<visual>
			<origin xyz="0 0 0" rpy="0 ${pi/2} 0"/>
				<geometry>
					<cylinder length="${length}" radius="${radius}"/>
				</geometry>
			<material name="Red">
				<color rgba="0.8 0.0 0.0 1.0"/>
			</material>
		</visual>

		<inertial>
			<mass value="1" />
			<origin xyz="0 0 0" rpy="0 ${pi/2} 0"/>
			<inertia ixx="1" ixy="0" ixz="0" iyy="1" iyz="0" izz="1" />
		</inertial>
	</link>

	<!-- 5th link -->
	<link name="left_back_wheel">
		<collision name="left_back_wheel">
			<origin xyz="0 0 0" rpy="0 ${pi/2} 0"/>
				<geometry>
					<cylinder length="${length}" radius="${radius}"/>
				</geometry>
		</collision>

		<visual>
			<origin xyz="0 0 0" rpy="0 ${pi/2} 0"/>
				<geometry>
					<cylinder length="${length}" radius="${radius}"/>
				</geometry>
			<material name="Red">
				<color rgba="0.8 0.0 0.0 1.0"/>
			</material>
		</visual>

		<inertial>
			<mass value="1" />
			<origin xyz="0 0 0" rpy="0 ${pi/2} 0"/>
			<inertia ixx="1" ixy="0" ixz="0" iyy="1" iyz="0" izz="1" />
		</inertial>
	</link>

  <!-- 6th link -->
  <link name="left_wheel_middle">
    <collision>
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <geometry>
        <box size="0.35 0.1 0.05"/>
      </geometry>
    </collision>

    <visual>
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <geometry>
        <box size="0.35 0.1 0.05"/>
      </geometry>
			<material name="Blue">
				<color rgba="0.0 0.0 0.8 1.0"/>
			</material>
    </visual>

    <inertial>
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <mass value="5"/>
      <inertia
        ixx="1.0" ixy="0.0" ixz="0.0"
        iyy="1.0" iyz="0.0"
        izz="1.0"/>
    </inertial>

  </link>

  <!-- 7th link -->
  <link name="right_wheel_middle">
    <collision>
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <geometry>
        <box size="0.35 0.1 0.05"/>
      </geometry>
    </collision>

    <visual>
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <geometry>
        <box size="0.35 0.1 0.05"/>
      </geometry>
			<material name="Blue">
				<color rgba="0.0 0.0 0.8 1.0"/>
			</material>
    </visual>

    <inertial>
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <mass value="5"/>
      <inertia
        ixx="1.0" ixy="0.0" ixz="0.0"
        iyy="1.0" iyz="0.0"
        izz="1.0"/>
    </inertial>
    
  </link>

  <!-- left back wheel joint differential-->
	<joint name="left_back_wheel_joint_differential" type="continuous">
		<origin xyz="0.2 -0.125 -0.05" rpy="0 0 ${pi/2}"/>
		<parent link="link_chassis"/>
		<child link="left_back_wheel"/>
		<limit effort="100" velocity="100"/>  
		<joint_properties damping="0.0" friction="0.0"/>  
	</joint>

  <!-- right back wheel joint differential-->
	<joint name="right_back_wheel_joint_differential" type="continuous">
		<origin xyz="0.2 0.125 -0.05" rpy="0 0 ${pi/2}"/>
		<parent link="link_chassis"/>
		<child link="right_back_wheel"/>
		<limit effort="100" velocity="100"/>  
		<joint_properties damping="0.0" friction="0.0"/>  
	</joint>

  <!-- left front wheel joint differential-->
	<joint name="left_front_wheel_joint_differential" type="continuous">
		<origin xyz="-0.2 -0.125 -0.05" rpy="0 0 ${pi/2}"/>
		<parent link="link_chassis"/>
		<child link="left_front_wheel"/>
		<limit effort="100" velocity="100"/>  
		<joint_properties damping="0.0" friction="0.0"/>  
	</joint>

  <!-- right front wheel joint differential-->
	<joint name="right_front_wheel_joint_differential" type="continuous">
		<origin xyz="-0.2 0.125 -0.05" rpy="0 0 ${pi/2}"/>
		<parent link="link_chassis"/>
		<child link="right_front_wheel"/>
		<limit effort="100" velocity="100"/>
		<joint_properties damping="0.0" friction="0.0"/>  
	</joint>5

  <!-- right wheel middle joint -->
	<joint name="right_wheel_middle_joint" type="fixed">
		<origin xyz="0 0.15 -0.01" rpy="${pi/2} 0 0"/>
		<parent link="link_chassis"/>
		<child link="right_wheel_middle"/>
		<limit effort="100" velocity="100"/>
		<joint_properties damping="0.0" friction="0.0"/>  
	</joint>

  <!-- left wheel middle joint -->
	<joint name="left_wheel_middle_joint" type="fixed">
		<origin xyz="0 -0.15 -0.01" rpy="${pi/2} 0 0"/>
		<parent link="link_chassis"/>
		<child link="left_wheel_middle"/>
		<limit effort="100" velocity="100"/>
		<joint_properties damping="0.0" friction="0.0"/>  
	</joint>

	<transmission name="left_back_wheel_joint_differential_tran">
		<type>transmission_interface/SimpleTransmission</type>
		<joint name="left_back_wheel_joint_differential">
			<hardwareInterface>hardware_interface/VelocityJointInterface</hardwareInterface>
		</joint>
		<actuator name="left_back_wheel_joint_differential_motor">
			<mechanicalReduction>1</mechanicalReduction>
			<hardwareInterface>hardware_interface/VelocityJointInterface</hardwareInterface>
		</actuator>
	</transmission>

	<transmission name="left_front_wheel_joint_differential_tran">
		<type>transmission_interface/SimpleTransmission</type>
		<joint name="left_front_wheel_joint_differential">
			<hardwareInterface>hardware_interface/VelocityJointInterface</hardwareInterface>
		</joint>
		<actuator name="left_front_wheel_joint_differential_motor">
			<mechanicalReduction>1</mechanicalReduction>
			<hardwareInterface>hardware_interface/VelocityJointInterface</hardwareInterface>
		</actuator>
	</transmission>

	<transmission name="right_front_wheel_joint_differential_tran">
		<type>transmission_interface/SimpleTransmission</type>
		<joint name="right_front_wheel_joint_differential">
			<hardwareInterface>hardware_interface/VelocityJointInterface</hardwareInterface>
		</joint>
		<actuator name="right_front_wheel_joint_differential_motor">
			<mechanicalReduction>1</mechanicalReduction>
			<hardwareInterface>hardware_interface/VelocityJointInterface</hardwareInterface>
		</actuator>
	</transmission>

	<transmission name="right_back_wheel_joint_differential_tran">
		<type>transmission_interface/SimpleTransmission</type>
		<joint name="right_back_wheel_joint_differential">
			<hardwareInterface>hardware_interface/VelocityJointInterface</hardwareInterface>
		</joint>
		<actuator name="right_back_wheel_joint_differential_motor">
			<mechanicalReduction>1</mechanicalReduction>
			<hardwareInterface>hardware_interface/VelocityJointInterface</hardwareInterface>
		</actuator>
	</transmission>

    <!-- camera body, with origin at bottom screw mount -->
    <joint name="${sensor_name}_joint" type="fixed">
      <origin xyz="-0.2 0 0.05" rpy="0 0 ${pi}"/>
      <parent link="link_chassis"/>
      <child link="${sensor_name}_bottom_screw_frame" />
    </joint>
    <link name="${sensor_name}_bottom_screw_frame"/>

    <joint name="${sensor_name}_link_joint" type="fixed">
      <origin xyz="0 ${d435_cam_depth_py} ${d435_cam_depth_pz}" rpy="0 0 0"/>
      <parent link="${sensor_name}_bottom_screw_frame"/>
      <child link="${sensor_name}_link" />
    </joint>

    <link name="${sensor_name}_link">
      <visual>
        <origin xyz="${d435_cam_mount_from_center_offset} ${-d435_cam_depth_py} 0" rpy="${pi/2} 0 ${pi/2}"/>
        <geometry>
          <mesh filename="package://realsense_ros_gazebo/meshes/realsense_d435.stl" />
        </geometry>
      </visual>
      <collision>
        <origin xyz="0 ${-d435_cam_depth_py} 0" rpy="0 0 0"/>
        <geometry>
          <box size="${d435_cam_depth} ${d435_cam_width} ${d435_cam_height}"/>
        </geometry>
      </collision>
      <inertial>
        <mass value="${d435_cam_mass}" />
        <origin xyz="0 ${-d435_cam_depth_py} 0" rpy="0 0 0"/>
		<inertia ixx="1" ixy="0" ixz="0" iyy="1" iyz="0" izz="1" />
      </inertial>
    </link>

    <!-- camera depth joints and links -->
    <joint name="${sensor_name}_depth_joint" type="fixed">
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <parent link="${sensor_name}_link"/>
      <child link="${sensor_name}_depth_frame" />
    </joint>
    <link name="${sensor_name}_depth_frame"/>

    <joint name="${sensor_name}_depth_optical_joint" type="fixed">
      <origin xyz="0 0 0" rpy="${-pi/2} 0 ${-pi/2}" />
      <parent link="${sensor_name}_depth_frame" />
      <child link="${sensor_name}_depth_optical_frame" />
    </joint>
    <link name="${sensor_name}_depth_optical_frame"/>

    <!-- camera left IR joints and links -->
    <joint name="${sensor_name}_left_ir_joint" type="fixed">
      <origin xyz="0 ${d435_cam_depth_to_left_ir_offset} 0" rpy="0 0 0" />
      <parent link="${sensor_name}_depth_frame" />
      <child link="${sensor_name}_left_ir_frame" />
    </joint>
    <link name="${sensor_name}_left_ir_frame"/>

    <joint name="${sensor_name}_left_ir_optical_joint" type="fixed">
      <origin xyz="0 0 0" rpy="${-pi/2} 0 ${-pi/2}" />
      <parent link="${sensor_name}_left_ir_frame" />
      <child link="${sensor_name}_left_ir_optical_frame" />
    </joint>
    <link name="${sensor_name}_left_ir_optical_frame"/>

    <!-- camera right IR joints and links -->
    <joint name="${sensor_name}_right_ir_joint" type="fixed">
      <origin xyz="0 ${d435_cam_depth_to_right_ir_offset} 0" rpy="0 0 0" />
      <parent link="${sensor_name}_depth_frame" />
      <child link="${sensor_name}_right_ir_frame" />
    </joint>
    <link name="${sensor_name}_right_ir_frame"/>

    <joint name="${sensor_name}_right_ir_optical_joint" type="fixed">
      <origin xyz="0 0 0" rpy="${-pi/2} 0 ${-pi/2}" />
      <parent link="${sensor_name}_right_ir_frame" />
      <child link="${sensor_name}_right_ir_optical_frame" />
    </joint>
    <link name="${sensor_name}_right_ir_optical_frame"/>

    <!-- camera color joints and links -->
    <joint name="${sensor_name}_color_joint" type="fixed">
      <origin xyz="0 ${d435_cam_depth_to_color_offset} 0" rpy="0 0 0" />
      <parent link="${sensor_name}_depth_frame" />
      <child link="${sensor_name}_color_frame" />
    </joint>
    <link name="${sensor_name}_color_frame"/>

    <joint name="${sensor_name}_color_optical_joint" type="fixed">
      <origin xyz="0 0 0" rpy="${-pi/2} 0 ${-pi/2}" />
      <parent link="${sensor_name}_color_frame" />
      <child link="${sensor_name}_color_optical_frame" />
    </joint>
    <link name="${sensor_name}_color_optical_frame"/>

    <!-- gazebo plugin -->

    <xacro:property name="deg_to_rad" value="0.01745329251994329577" />

    <gazebo reference="${sensor_name}_link">
      <self_collide>0</self_collide>
      <enable_wind>0</enable_wind>
      <kinematic>0</kinematic>
      <gravity>1</gravity>
      <mu2>1</mu2>
      <fdir1>0 0 0</fdir1>
      <kp>1e+13</kp>
      <kd>1</kd>

      <sensor name="${sensor_name}_color" type="camera">
        <camera name="${sensor_name}">
          <horizontal_fov>${69.4*deg_to_rad}</horizontal_fov>
          <image>
            <width>640</width>
            <height>480</height>
            <format>RGB_INT8</format>
          </image>
          <clip>
            <near>0.1</near>
            <far>100</far>
          </clip>
          <noise>
            <type>gaussian</type>
            <mean>0.0</mean>
            <stddev>0.007</stddev>
          </noise>
        </camera>
        <always_on>1</always_on>
        <update_rate>60</update_rate>
        <visualize>1</visualize>
      </sensor>
      <sensor name="${sensor_name}_ired1" type="camera">
        <camera name="${sensor_name}">
          <horizontal_fov>${85.2*deg_to_rad}</horizontal_fov>
          <image>
            <width>1280</width>
            <height>720</height>
            <format>L_INT8</format>
          </image>
          <clip>
            <near>0.1</near>
            <far>100</far>
          </clip>
          <noise>
            <type>gaussian</type>
            <mean>0.0</mean>
            <stddev>0.05</stddev>
          </noise>
        </camera>
        <always_on>0</always_on>
        <update_rate>90</update_rate>
        <visualize>0</visualize>
      </sensor>
      <sensor name="${sensor_name}_ired2" type="camera">
        <camera name="${sensor_name}">
          <horizontal_fov>${85.2*deg_to_rad}</horizontal_fov>
          <image>
            <width>1280</width>
            <height>720</height>
            <format>L_INT8</format>
          </image>
          <clip>
            <near>0.1</near>
            <far>100</far>
          </clip>
          <noise>
            <type>gaussian</type>
            <mean>0.0</mean>
            <stddev>0.05</stddev>
          </noise>
        </camera>
        <always_on>0</always_on>
        <update_rate>90</update_rate>
        <visualize>0</visualize>
      </sensor>
      <sensor name="${sensor_name}_depth" type="depth">
        <camera name="${sensor_name}">
          <horizontal_fov>${85.2*deg_to_rad}</horizontal_fov>
          <image>
            <width>1280</width>
            <height>720</height>
          </image>
          <clip>
            <near>0.1</near>
            <far>100</far>
          </clip>
          <noise>
            <type>gaussian</type>
            <mean>0.0</mean>
            <stddev>0.100</stddev>
          </noise>
        </camera>
        <always_on>1</always_on>
        <update_rate>90</update_rate>
        <visualize>0</visualize>
      </sensor>
    </gazebo>

    <gazebo>
      <plugin name="${sensor_name}" filename="librealsense_gazebo_plugin.so">
        <prefix>${sensor_name}_</prefix>
        <depthUpdateRate>${rate}</depthUpdateRate>
        <colorUpdateRate>${rate}</colorUpdateRate>
        <infraredUpdateRate>${rate}</infraredUpdateRate>
        <depthTopicName>depth/image_raw</depthTopicName>
        <depthCameraInfoTopicName>depth/camera_info</depthCameraInfoTopicName>
        <colorTopicName>color/image_raw</colorTopicName>
        <colorCameraInfoTopicName>color/camera_info</colorCameraInfoTopicName>
        <infrared1TopicName>infra1/image_raw</infrared1TopicName>
        <infrared1CameraInfoTopicName>infra1/camera_info</infrared1CameraInfoTopicName>
        <infrared2TopicName>infra2/image_raw</infrared2TopicName>
        <infrared2CameraInfoTopicName>infra2/camera_info</infrared2CameraInfoTopicName>
        <colorOpticalframeName>${sensor_name}_color_optical_frame</colorOpticalframeName>
        <depthOpticalframeName>${sensor_name}_depth_optical_frame</depthOpticalframeName>
        <infrared1OpticalframeName>${sensor_name}_infrared1_optical_frame</infrared1OpticalframeName>
        <infrared2OpticalframeName>${sensor_name}_infrared2_optical_frame</infrared2OpticalframeName>
        <rangeMinDepth>0.2</rangeMinDepth>
        <rangeMaxDepth>10.0</rangeMaxDepth>
        <pointCloud>false</pointCloud>
        <pointCloudTopicName>depth/color/points</pointCloudTopicName>
        <pointCloudCutoff>0.25</pointCloudCutoff>
        <pointCloudCutoffMax>9.0</pointCloudCutoffMax>
      </plugin>
    </gazebo>

        <gazebo>
          <plugin name="car_imu_sim" filename="libhector_gazebo_ros_imu.so">
            <updateRate>100.0</updateRate>
            <bodyName>link_chassis</bodyName>
            <frameId>link_chassis</frameId>
            <topicName>raw_imu</topicName>
            <rpyOffset>0 0 0</rpyOffset> <!-- deprecated -->
            <gaussianNoise>0</gaussianNoise>  <!-- deprecated -->
            <accelDrift>0.1 0.1 0.1</accelDrift>
            <accelGaussianNoise>0.35 0.35 0.3</accelGaussianNoise>
            <rateDrift>0.1 0.1 0.1</rateDrift>
            <rateGaussianNoise>0.05 0.05 0.015</rateGaussianNoise>
          </plugin>

          <plugin name="car_gps_sim" filename="libhector_gazebo_ros_gps.so">
            <updateRate>4.0</updateRate>
            <bodyName>link_chassis</bodyName>
            <frameId>link_chassis</frameId>
            <topicName>fix</topicName>
            <velocityTopicName>fix_velocity</velocityTopicName>
            <referenceLatitude>49.860246</referenceLatitude>
            <referenceLongitude>8.687077</referenceLongitude>
            <drift>5.0 5.0 5.0</drift>
            <gaussianNoise>0.01 0.01 0.01</gaussianNoise>
            <velocityDrift>0 0 0</velocityDrift>
            <velocityGaussianNoise>0.05 0.05 0.05</velocityGaussianNoise>
          </plugin>

          <plugin name="differential_drive_controller" filename="libgazebo_ros_diff_drive.so">
            <alwaysOn>true</alwaysOn>
            <updateRate>50.0</updateRate>
            <leftJoint>left_back_wheel_joint</leftJoint>
            <rightJoint>right_back_wheel_joint</rightJoint>
            <wheelSeparation>0.25</wheelSeparation>
            <wheelDiameter>0.1</wheelDiameter>
            <torque>1.0</torque>
            <commandTopic>cmd_vel</commandTopic>
            <odometryTopic>odom</odometryTopic>
            <odometryFrame>odom</odometryFrame>
            <robotBaseFrame>link_chassis</robotBaseFrame>
            <publishWheelTF>true</publishWheelTF>
            <publishWheelJointState>true</publishWheelJointState>
            <legecyMode>true</legecyMode>
            <wheelAcceleration>1</wheelAcceleration>
            <rosDebugLevel>na</rosDebugLevel>
            <publishOdomTF>true</publishOdomTF>
            <wheelTorque>5</wheelTorque>
            <odometrySource>world</odometrySource>
            <publishTf>1</publishTf>
          </plugin>
        </gazebo>

        <gazebo>
          <plugin name="gazebo_ros_control" filename="libgazebo_ros_control.so">
            <robotNamespace>/my_robot</robotNamespace>
            <robotSimType>gazebo_ros_control/DefaultRobotHWSim</robotSimType>
          </plugin>
        </gazebo>

</robot>